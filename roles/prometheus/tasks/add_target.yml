---
- name: Assert Input params
  ansible.builtin.assert:
    that:
      - resource_id is defined and resource_id | length > 0
      - _node_exporter_port is defined
      - _consul_url is defined
      - _consul_token is defined

- name: Get consul node
  ansible.builtin.uri:
    url: "{{ _consul_url }}/v1/catalog/nodes?filter=ID==\"{{ resource_id }}\""
    method: GET
    headers:
      Authorization: "Bearer {{ _consul_token }}"
  register: consul_node

- name: Add service to consul node
  ansible.builtin.uri:
    url: "{{ _consul_url }}/v1/catalog/register"
    method: PUT
    headers:
      Authorization: "Bearer {{ _consul_token }}"
    body_format: json
    body:
      ID: "{{ resource_id }}"
      Node: "{{ consul_node['json'][0]['Node'] }}"
      Address: "{{ consul_node['json'][0]['Address'] }}"
      SkipNodeUpdate: true
      Service:
        Service: "node_exporter"
        Port: "{{ _node_exporter_port }}"
        Tags:
          - "prometheus"
        Meta:
          resource_id: "{{ resource_id }}"
